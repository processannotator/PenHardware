<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="render-view">
	
	<template>
		<style>
			:host {
				margin: 0;
			}
			
			:host:hover {
			}
			
			canvas {
				width: 100%;
				height: 100%;
			}
			
		</style>

	</template>

	<script>
		// FIXME: shouldnt those global variables better reside inside the element
		// vis this.glRenderer = ...
		var glScene = new THREE.Scene()
		var cssScene = new THREE.Scene()
		var camera
		var controls
		var cssObject
		var glRenderer
		var cube
		var cssRenderer
		var render
		var animate
		
		Polymer({
			is: "render-view",
      properties: {
        model: Object,
				annotations: {
					type: Array,
					observer: "updateAnnotations"
				}
      },
			ready: function() {
				
				// init animate() and render()
				animate = function () {
					requestAnimationFrame( animate )
					controls.update()
				}
				
				render = function() {
					// triggered on controls.update() and resize()
					glRenderer.render( glScene, camera )
					cssRenderer.render( cssScene, camera )
				}

			},
			attached: function () {
				let width = this.parentNode.getBoundingClientRect().width
				let height = this.parentNode.getBoundingClientRect().height
				
				camera = new THREE.PerspectiveCamera( 75, width / height, 0.025, width*4 )
				camera.position.set(800, 800, 800)
				
				glRenderer = new THREE.WebGLRenderer( { antialias: true, alpha:true } )
				glRenderer.setClearColor(0x00ff00, 0.0)
				glRenderer.setSize(width, height)
				
				// let both renderers/canvases overlap
				glRenderer.domElement.style.position = 'absolute';
				glRenderer.domElement.style.top = 0;
				
				cssRenderer = new THREE.CSS3DRenderer()
				cssRenderer.setSize(width, height)


				controls = new THREE.TrackballControls( camera, cssRenderer.domElement )

				controls.rotateSpeed = 1.0
				controls.zoomSpeed = 1.2
				controls.panSpeed = 0.8
				
				controls.noZoom = false
				controls.noPan = false
				
				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3
				controls.keys = [ 65, 83, 68 ]
				
				var geometry = new THREE.BoxGeometry( 700, 700, 700 )
				var material = new THREE.MeshNormalMaterial( { color: 0x00ff00 } )
				cube = new THREE.Mesh( geometry, material )
				cube.rotation.y = 1
				glScene.add( cube )
				
				blubb = document.createElement( 'div' )
				blubb.style.opacity = 1.0
				blubb.style.fontSize = '50px'
				blubb.style.background = "rgba(200, 200, 200, 0.5)"
				blubb.innerHTML = "this is an annotation.<br>with some text."
				cssObject = new THREE.CSS3DSprite( blubb )
				cssScene.add( cssObject )

				Polymer.dom(this.root).appendChild(glRenderer.domElement)
				Polymer.dom(this.root).appendChild(cssRenderer.domElement)
				controls.addEventListener( 'change', render )
				controls.handleResize()
				render()
				animate()
			},
			resize: function (event) {
				let width = this.parentNode.getBoundingClientRect().width
				let height = this.parentNode.getBoundingClientRect().height
				glRenderer.setSize(width, height)
				cssRenderer.setSize(width, height)
				camera.aspect = width / height
				camera.updateProjectionMatrix()
				controls.handleResize()
				render()
			},
			updateAnnotations: function () {
				// debug output of annotations
				console.log(this.annotations)
				
				// first remove all previous annotations
				// FIXME: only update modified ones, instead of removing and completely re-creating
				for (let child of cssScene.children) {
					cssScene.remove(child)
				}
				
				for (let {doc} of this.annotations) {
					console.log(doc.position)
					console.log(doc)
					var annotationCSS3DElement = document.createElement( 'div' )
					annotationCSS3DElement.style.opacity = 1.0
					annotationCSS3DElement.style.fontSize = '50px'
					annotationCSS3DElement.style.background = "rgba(200, 200, 200, 0.5)"
					annotationCSS3DElement.innerHTML = doc.description
					var annotationCSS3DObject = new THREE.CSS3DSprite( annotationCSS3DElement )
					annotationCSS3DObject.position.set(doc.position[0] * 2, doc.position[1] * 2, 0)
					console.log(annotationCSS3DObject.position)
					cssScene.add( annotationCSS3DObject )
				}
				
				render()
				
			}

		})

	</script>

</dom-module>